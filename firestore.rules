rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // School info — only authenticated admins
    match /schools/{schoolId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if false;
    }

    // Elections
    match /elections/{electionId} {
      // Public read: voters need election info on ballot page
      allow read: if true;
      allow create: if request.auth != null;
      // Only authenticated admins can update (Cloud Functions use admin SDK)
      allow update: if request.auth != null;
      allow delete: if false;
    }

    // Votes (top-level collection)
    // All vote creation now happens via Cloud Functions (admin SDK bypasses rules)
    match /votes/{voteId} {
      allow create: if false;
      allow read: if request.auth != null;
      allow update: if false;
      // Authenticated admins can delete votes (data purge after finalization)
      allow delete: if request.auth != null;
    }

    // Voter codes (top-level collection)
    // Code lookup and marking as used now happens via Cloud Functions
    match /voterCodes/{codeId} {
      // Read restricted to authenticated admins (Cloud Functions use admin SDK for lookups)
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if false;
      // Authenticated admins can delete codes (data purge after finalization)
      allow delete: if request.auth != null;
    }

    // Hash chain (top-level collection)
    // All hash chain creation now happens via Cloud Functions
    match /hashChain/{blockId} {
      // Authenticated read for verification UI
      allow read: if request.auth != null;
      allow create: if false;
      allow update, delete: if false;
    }

    // Users
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Audit logs — only Cloud Functions create these now
    match /auditLogs/{logId} {
      allow read: if request.auth != null;
      allow create: if false;
      allow update, delete: if false;
    }
  }
}
